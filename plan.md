# New Project Plan

## Notes

- User's name is Shunt.
- Project is in JavaScript, English, Windows environment.
- User builds web, desktop, mobile, and tablet apps.
- Uses npm, git, MongoDB, JWT, bcryptjs, cookie-parser, cors, dotenv, express, helmet, zod, mongoose, errorhandler, asyncHandler, winston, rate-limiter.
- Session with IP tracking required for authentication.
- Project just started ("ceci est un nouveau project").
- Backend is now initialized with full authentication API and documentation.
- User wants a full-stack project (frontend + backend).
- User chose to use the existing `express-auth-api` directory as the project base.
- User decided to postpone frontend work and focus on the API/backend for now.
- User prefers a folder structure with controllers, services, models, validations, etc. (not the current structure).
- Backend refactor to preferred folder structure is in progress and partially complete.
- User is dissatisfied with current file names and requests naming options.
- User prefers Snake Case for file naming (see global rules).
- All backend files have been migrated to snake_case naming convention.
- User requested to simplify and logically group all Mongoose schema indexes (unique, advanced, etc.) for clarity and maintainability, while preserving all current index functionality.
- Simplified and reorganized all Mongoose schema indexes: removed separate "Unique indexes" and "Advanced indexes" sections, consolidated all indexes under single "Database indexes" section. Moved Session model field-level indexes to schema level for consistency across all models.
- Index simplification completed across all models.
- All models have been recreated and renamed in snake_case (user_model.js, session_model.js, profile_model.js) per updated preferences.
- User requested to also rename route files to snake_case (e.g., auth_routes.js, user_routes.js) for consistency.
- User requested config and middleware files should also be renamed to snake_case for consistency.
- All config and middleware files have been renamed to snake_case (e.g., database_config.js, logger_config.js, auth_middleware.js, error_handler.js) and all imports updated accordingly.
- User requested to centralize environment variable management and enforce presence/validation of required env variables at startup, with detailed error and app exit if missing.
- Centralized env variable management and validation implemented via env_config.js; .env.example updated.
- User requested to split server.js into app.js (Express app definition) and server.js (startup/bootstrap) for better structure.
- Rate limiting should be centralized in a dedicated middleware/module (not defined inline in app.js).
- Rate limiting is now centralized in middleware/rate_limiter.js and integrated in app and routes.
- User requested to add an index.js file in each folder (controllers, services, models, validations, middleware, config, routes) to centralize and simplify imports.
- All index.js barrel files created for each folder and imports refactored to use them.
- User requested all API route mounting (e.g. app.use('/api/auth', ...)) to be moved from app.js into routes/index.js, leaving only app.use('/api/', apiLimiter) in app.js for maximum modularity.
- All API route mounting is now handled in routes/index.js; app.js only uses apiLimiter and mounts the centralized API router for maximum modularity.
- User wants to unify all environment variable usage under a single access pattern (e.g., env.variable) for consistency across the codebase.
- All environment variable usage is now unified under the env.variable pattern throughout the backend codebase for consistency and clarity.
- All npm packages have been upgraded to their latest versions using npm-check-updates and npm install. Code may need review for compatibility with new major versions (e.g., express 5.x, helmet 8.x, zod 4.x, etc).
- After upgrade to Express 5.x, server startup fails due to a path-to-regexp error; breaking changes in route handling must be addressed for compatibility.
- Even minimal Express 5.x route definitions fail with path-to-regexp error; urgent compatibility fix needed for core routing.
- User does not want to downgrade Express or add packages; compatibility must be achieved with Express 5.x as-is.
- Minimal and progressive Express 5.x servers work; error is isolated to main app configuration or route mounting, not route definitions themselves.
- Persistent path-to-regexp error remains in main app despite matching test server setup; must isolate difference between test and production app configuration.
- Direct import of individual route files works; importing routes/index.js fails with path-to-regexp error—problem is inside routes/index.js.
- Root cause: wildcard route in routes/index.js (`apiRouter.all('*')`) was not Express 5.x compatible; replaced with `apiRouter.use()` handler and backend now starts successfully with Express 5.x.
- Mongoose duplicate index and deprecation warnings present in logs; needs resolution.
- Note: suppressReservedKeysWarning is not a valid Mongoose option and should not be used.
- suppressReservedKeysWarning option was removed; explicit schema index management needed for duplicate index warnings.
- Next: Remove unique: true from user model fields and add explicit unique indexes at the schema level to resolve duplicate index warnings in Mongoose 8.x.
- Remove all field-level unique constraints from user model; use only schema-level unique indexes to resolve duplicate index warnings in Mongoose 8.x.
- Duplicate index warnings resolved: no field-level unique constraints remain; backend is warning-free.
- Comprehensive test suite implemented: unit tests for services, integration tests for API routes, validation tests for Zod schemas (115 tests total).
- All tests passing successfully with proper test isolation and cleanup.
- Message centralization completed: all success, error, and validation messages moved to constants/messages.js with centralized imports.
- All source code (controllers, services, middlewares, validations) updated to use centralized messages.
- All tests (unit and integration) updated to use centralized message constants for assertions.
- Project is now ready for next phase: CI/CD pipeline, documentation, or new features.
- All redundant/duplicate log messages have been eliminated; backend now uses only Winston for logging with no console.log duplication.
- Registration endpoint modified to NOT automatically log in users; now returns success message only, preparing for future email verification implementation.
- **IMPORTANT**: User requires plan.md to be updated after every significant change for proper project tracking and documentation.
- User questioned necessity of all tokens returned in login response (accessToken, refreshToken, sessionId, tokenType); considering simplification of login response to return only essential data.
- Login response simplified to return only essential data: accessToken, refreshToken, and user info. Removed redundant sessionId, tokenType, and expiresIn fields.
- User questioned why tokens are returned in JSON response when cookies are already used; considering removing token redundancy for better security (cookies-only approach).
- Implemented cookies-only authentication: removed accessToken and refreshToken from JSON responses in login and refresh endpoints. Tokens now exist only in secure httpOnly cookies for better security.
- Removed duplicate token expiry configuration from AuthService (ACCESS_TOKEN_EXPIRY, REFRESH_TOKEN_EXPIRY) and now use centralized env_config.js values. Added parseJwtTime utility to convert JWT time strings to milliseconds.
- Completed configuration centralization by adding SESSION_EXPIRES_IN to env_config.js and removing hardcoded SESSION_EXPIRY from AuthService. All token/session expiry times now centralized in environment configuration.
- User questioned the purpose of deviceFingerprint in session management; considering whether to simplify or strengthen this security feature.
- Removed deviceFingerprint completely from the codebase: deleted generateDeviceFingerprint method from AuthService, removed field from Session model, and cleaned up all references in services and controllers for code simplification.
- Logging is now handled exclusively by Winston; backend logging is clean, consistent, and production-ready.
- Circular dependency between env_config.js and logger_config.js is the root cause of logger config import errors; next step is to break this circular dependency so centralized env config can be used everywhere as intended.
- Break circular dependency between env_config.js and logger_config.js so env can be used everywhere.
- Circular dependency is now resolved; centralized env config can be used everywhere for consistent configuration.
- Winston log files are now automatically cleared/reset at each dev server start for fresh logs.
- Remove `firstName` and `lastName` from the user model as they are not needed.
- Remove explicit `createdAt` and `updatedAt` fields from user model; rely on `timestamps: true` for these fields.
- Removed firstName/lastName and redundant createdAt/updatedAt from user model.
- User model further simplified: removed unnecessary autoIndex and toJSON options from schema.
- Strategic indexes for performance and data integrity added to user model (role, isActive, isEmailVerified, lastLogin, tokens, TTL, compound).
- User clarified intent to discuss `index: true` at the schema field level (vs. userSchema.index()).
- Decision: Use hybrid index strategy—`index: true` for simple fields, keep only advanced (TTL, sparse, compound) indexes at schema level for user model.
- Only essential comments remain in user_model.js after cleanup.
- User questioned the need for a separate sessionId in session_model.js since MongoDB already provides an \_id; rationale and necessity under review.
- sessionId field has been removed from session_model.js; session model now uses MongoDB \_id for session identification.
- profile_model.js has been refactored and simplified as per user edits.
- profile_model.js has been fully cleaned up: removed virtuals and references to deleted fields, fixed indexes, and eliminated redundant fields and middleware.
- twoFactorAuth is now nested under preferences in profile_model.js; all references and methods updated accordingly.
- Services (auth_service.js, user_service.js) refactored to match updated model structures (user, session, profile).
- Controllers (auth_controller.js, etc.) refactored to match updated model structures (removed sessionId, updated for new session/profile models). Backend model-service-controller consistency achieved.
- Error: 'config is not defined' in middleware/rate_limiter.js (line 62). Centralized config import or usage must be fixed for rate limiter middleware to work.
- All references to `config.isTest` and other `config` values in rate_limiter.js must be updated to use `env.isTest` or the appropriate centralized env variable. This will resolve the current error and ensure consistent configuration usage in all rate limiter skip logic and options.
- All references to `config` in rate_limiter.js have been replaced with the appropriate `env` variables, and centralized configuration usage is now consistent. The error regarding 'config is not defined' is resolved.

## Task List

- [x] Audit and clean up existing backend code
- [x] Set up npm and git (if not already)
- [x] Configure basic project structure
- [ ] Set up frontend (web app scaffold)
- [x] Refactor backend to preferred folder structure (controllers, services, models, validations, etc)
- [x] Apply Snake Case naming to all backend files
- [x] Rename models to snake_case (e.g., auth_model.js)
- [x] Recreate models (profile, user, session) as per new preferences
- [x] Rename route files to snake_case (e.g., auth_routes.js, user_routes.js)
- [x] Rename config and middleware files to snake_case
- [x] Centralize env variable management and validate required envs at startup
- [x] Split server.js into app.js (Express app definition) and server.js (bootstrap)
- [x] Centralize rate limiting into its own middleware/module
- [x] Add index.js file in each folder to centralize exports and facilitate imports
- [x] Move all API route mounting from app.js to routes/index.js, leaving only apiLimiter in app.js
- [x] Upgrade all npm packages to latest versions and verify compatibility
- [x] Debug and fix routes/index.js path-to-regexp error
- [x] Ensure no field-level unique constraints remain; resolve all duplicate index warnings
- [x] Eliminate redundant/duplicate log messages from server output
- [x] Backend logging is now Winston-only and clean
- [x] Refactor logger_config.js to use centralized env config without circular dependency
- [x] Break circular dependency between env_config.js and logger_config.js so env can be used everywhere
- [x] Reset/clear Winston log files on each dev server start
- [x] Remove firstName/lastName and redundant createdAt/updatedAt from user model
- [x] Analyze and add relevant indexes to user model fields
- [x] Refactor user model to use hybrid index strategy (field-level `index: true` for simple fields, keep only advanced indexes at schema level)
- [x] Clean up comments in user_model.js, keep only essential ones
- [x] Remove redundant sessionId field from session_model.js and use \_id for session identification
- [x] Clean up and finalize profile_model.js: remove virtuals, fix indexes, eliminate redundant fields and middleware
- [x] Move twoFactorAuth under preferences in profile_model.js and remove empty preferences object
- [x] Refactor services to match updated model structures (user, session, profile)
- [x] Refactor controllers to match updated model structures (remove sessionId, update for new session/profile models)
- [x] Update all rate limiter skip/config logic to use env variables
- [x] Fix rate_limiter.js to use centralized config/env import (resolve 'config is not defined')
- [x] Implement Zod-only validation approach for all backend validation
- [x] Implemented Zod-only validation approach: removed all business validation rules from User and Profile models (minlength, maxlength, match patterns), keeping only database constraints (required, unique indexes). All validation now handled by existing Zod schemas.
- [x] Validation centralization completed: single source of truth achieved with Zod handling all business validation and Mongoose handling only database persistence and constraints. Maintenance simplified to single location per validation rule.

## Current Goal

Continue backend feature development
